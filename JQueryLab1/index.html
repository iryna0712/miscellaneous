<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script>
        var areEventsEnabled = false;
        var animationToLeftCancelled = false;
        var animationToRightCancelled = false;

        $(function() {
            toggleEventProcessing();
        });

        /* used to disable/enable event processing before/after animation */
        function toggleEventProcessing() {
            if (!areEventsEnabled) {
                $('.rating-circle').on('mouseenter', animateNodesToTheRight);
                $('.rating-circle').on('mouseleave', animateNodesToTheLeft);
                $('.rating-circle').on('click', changeColor);

            } else {
                $('.rating-circle').off();
            }

            areEventsEnabled = !areEventsEnabled;
        }

        function reset() {
            $('.rating-circle').stop(true,true);

            $('.rating-circle').data('animationToLeftFinished', 'false');
            $('.rating-circle').data('animationToRightFinished', 'false');
        }

        function animateNodesToTheLeft(event) {
            //event.stopPropagation();
            animationToRightCancelled = true;
            animationToLeftCancelled = false;

            console.log('animate to left');
            reset();

            var parentNode = $('#rating-container');
            var untilNode = parentNode.children(':first');
            var animatedNode = $(this);

            animateSequentiallyToTheLeft(animatedNode, untilNode, parentNode);
        }

        function animateNodesToTheRight(event) {
            //event.stopPropagation();
            animationToLeftCancelled = true;
            animationToRightCancelled = false;

            console.log('animate to right');
            reset();

            //toggleEventProcessing();

            var parentNode = $('#rating-container');
            var untilNode = $(this);
            var animatedNode = parentNode.children(':first');

            animateSequentiallyToTheRight(animatedNode, untilNode, parentNode);
        }

        function animateSequentiallyToTheLeft(animated, until, parent) {
            console.log('animateSequentiallyToTheLeft');

            var wasUntilReached = parent.children().index(animated) < parent.children().index(until) ;
            var wasOverflowReached = (parent.children().index(animated) === -1);

            //console.log("wasUntilReached " + wasUntilReached);
            //console.log("wasOverflowReached " + wasOverflowReached);

            if (animationToLeftCancelled || wasUntilReached || wasOverflowReached ) {
                //toggleEventProcessing();
                return;
            }

            //skip animation if the element was already animated before
            var duration =  animated.data('animationToLeftFinished') === 'true' ? 0 : 185;

            animated.children(':first').animate(
                {width: '0%'},
                duration,
                'linear',
                function () {
                    animated.data('animationToLeftFinished', 'true');

                    animateSequentiallyToTheLeft(animated.prev(), until, parent);
                });
        }

        //this method is more or less general without referring to specific tags
        function animateSequentiallyToTheRight(animated, until, parent) {
            console.log('animateSequentiallyToTheRight');

            var wasUntilReached = parent.children().index(animated) > parent.children().index(until) ;
            var wasOverflowReached = (parent.children().index(animated) === -1);

            if (animationToRightCancelled || wasUntilReached || wasOverflowReached ) {
                //toggleEventProcessing();
                return;
            }

            //skip animation if the element was already animated before
            var duration =  animated.data('animationToRightFinished') === 'true' ? 0 : 185;

            animated.children(':first').animate(
                {width: '100%'},
                duration,
                'linear',
                function () {
                    animated.data('animationToRightFinished', 'true');

                    animateSequentiallyToTheRight(animated.next(), until, parent);
                });
        }

        function changeColor() {
            $('.rating-circle-background').addClass('rating-chosen');
        }


    </script>
</head>
<body>
    <h1>Contoso Web Developer Conference</h1>
    <h2>Finding elements using jQuery</h2>
    <div>This session is about identifying elements using jQuery methods and selectors.</div>
    <h3>Rate this session</h3>

    <!-- this section can be created dynamically, change this if it is covered in the next modules -->
    <div id="rating-container">
        <div class="rating-circle">
            <div class="rating-circle-background"></div>
        </div>
        <div class="rating-circle">
            <div class="rating-circle-background"></div>
        </div>
        <div class="rating-circle">
            <div class="rating-circle-background"></div>
        </div>
        <div class="rating-circle">
            <div class="rating-circle-background"></div>
        </div>
        <div class="rating-circle">
            <div class="rating-circle-background"></div>
        </div>
    </div>

</body>
</html>